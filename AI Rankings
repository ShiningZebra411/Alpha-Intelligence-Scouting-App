import React, { useState, useMemo } from 'react';
import { Link } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { base44 } from '@/api/base44Client';
import { useQuery, useMutation } from '@tanstack/react-query';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Input } from '@/components/ui/input';
import { motion } from 'framer-motion';
import BackgroundWrapper from '@/components/BackgroundWrapper';
import { ArrowLeft, Brain, Star, Loader2, Trophy, Gamepad2, Flag, TrendingUp, Search } from 'lucide-react';

export default function AIRankings() {
  const [selectedEvent, setSelectedEvent] = useState(null);
  const [aiRankings, setAiRankings] = useState(null);
  const [searchQuery, setSearchQuery] = useState('');

  const { data: events = [] } = useQuery({
    queryKey: ['events'],
    queryFn: () => base44.entities.Event.list('-created_date'),
  });

  const { data: matches = [] } = useQuery({
    queryKey: ['matches', selectedEvent],
    queryFn: () => base44.entities.MatchScout.filter({ event_id: selectedEvent }),
    enabled: !!selectedEvent,
  });

  const generateRankingsMutation = useMutation({
    mutationFn: async () => {
      const uniqueTeams = [...new Set(matches.map(m => m.team_number))];
      
      const teamStats = uniqueTeams.map(team => {
        const teamMatches = matches.filter(m => m.team_number === team);
        const avgScore = teamMatches.reduce((s, m) => s + (m.total_score || 0), 0) / teamMatches.length;
        const avgAuto = teamMatches.reduce((s, m) => s + (m.auto_score || 0), 0) / teamMatches.length;
        const avgTeleop = teamMatches.reduce((s, m) => s + (m.teleop_score || 0), 0) / teamMatches.length;
        const avgEndgame = teamMatches.reduce((s, m) => s + (m.endgame_score || 0), 0) / teamMatches.length;
        const maxScore = Math.max(...teamMatches.map(m => m.total_score || 0));
        const minScore = Math.min(...teamMatches.map(m => m.total_score || 0));
        const avgDefense = teamMatches.reduce((s, m) => s + (m.defense_rating || 3), 0) / teamMatches.length;
        const avgDriver = teamMatches.reduce((s, m) => s + (m.driver_skill || 3), 0) / teamMatches.length;
        const avgOverall = teamMatches.reduce((s, m) => s + (m.overall_rating || 5), 0) / teamMatches.length;
        
        return {
          team_number: team,
          matches_count: teamMatches.length,
          avg_score: Math.round(avgScore),
          avg_auto: Math.round(avgAuto),
          avg_teleop: Math.round(avgTeleop),
          avg_endgame: Math.round(avgEndgame),
          max_score: maxScore,
          min_score: minScore,
          avg_defense: avgDefense.toFixed(1),
          avg_driver: avgDriver.toFixed(1),
          avg_overall: avgOverall.toFixed(1)
        };
      });

      const prompt = `You are an expert FTC (FIRST Tech Challenge) DECODE 2025-2026 season scouting analyst. 

IMPORTANT: Use ALL available data sources to analyze these teams:
1. The scouted match data provided below
2. FTC Scout (ftcscout.org) - historical team performance data
3. FTC Stats (ftcstats.org/2026) - statistical analysis for DECODE season
4. FIRST Events (ftc-events.firstinspires.org) - official competition results

Team Statistics from our scouted matches:
${JSON.stringify(teamStats, null, 2)}

For each team, research and combine:
- Our scouted data (provided above)
- Their OPR/CCWM from ftcstats.org for DECODE season
- Their match history and rankings from official FIRST events
- Their historical performance from FTC Scout

Provide comprehensive rankings with:
1. A star rating out of 10 for each team (can use decimals like 7.5, 8.25)
2. Analysis combining ALL data sources

Consider: consistency, OPR trends, autonomous capability, teleop efficiency, endgame reliability, and competition performance across all events.

Return a JSON object with this exact structure:
{
  "rankings": [
    {
      "team_number": number,
      "star_rating": number (1-10),
      "rank": number,
      "avg_score": number,
      "avg_auto": number,
      "avg_teleop": number,
      "avg_endgame": number,
      "max_score": number,
      "min_score": number,
      "strengths": "brief strengths",
      "analysis": "brief analysis"
    }
  ]
}

Sort by star_rating descending, then avg_score descending.`;

      const result = await base44.integrations.Core.InvokeLLM({
        prompt,
        add_context_from_internet: true,
        response_json_schema: {
          type: "object",
          properties: {
            rankings: {
              type: "array",
              items: {
                type: "object",
                properties: {
                  team_number: { type: "number" },
                  star_rating: { type: "number" },
                  rank: { type: "number" },
                  avg_score: { type: "number" },
                  avg_auto: { type: "number" },
                  avg_teleop: { type: "number" },
                  avg_endgame: { type: "number" },
                  max_score: { type: "number" },
                  min_score: { type: "number" },
                  strengths: { type: "string" },
                  analysis: { type: "string" }
                }
              }
            }
          }
        }
      });

      return result;
    },
    onSuccess: (data) => {
      setAiRankings(data.rankings);
    }
  });

  const filteredRankings = useMemo(() => {
    if (!aiRankings) return null;
    if (!searchQuery.trim()) return aiRankings;
    return aiRankings.filter(team => 
      team.team_number.toString().includes(searchQuery.trim())
    );
  }, [aiRankings, searchQuery]);

  const handleGenerateRankings = () => {
    if (matches.length > 0) {
      generateRankingsMutation.mutate();
    }
  };

  return (
    <BackgroundWrapper>
      <div className="bg-zinc-950/80 backdrop-blur-xl border-b border-zinc-900 sticky top-0 z-50">
        <div className="max-w-6xl mx-auto px-4 py-4">
          <Link to={createPageUrl('Home')} className="flex items-center gap-2 text-zinc-400 hover:text-white transition-colors">
            <ArrowLeft className="h-4 w-4" />
            <span className="text-sm">Home</span>
          </Link>
        </div>
      </div>

      <div className="max-w-6xl mx-auto px-4 py-8">
        <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="mb-8">
          <div className="flex items-center gap-3 mb-2">
            <Brain className="h-8 w-8 text-purple-400" />
            <h1 className="text-3xl font-bold text-white">AI Rankings</h1>
          </div>
          <p className="text-zinc-500">AI-powered team analysis using scouted data and FTC statistics</p>
        </motion.div>

        <div className="flex flex-col sm:flex-row gap-4 mb-8">
          <Select value={selectedEvent || ''} onValueChange={(v) => { setSelectedEvent(v); setAiRankings(null); }}>
            <SelectTrigger className="w-full max-w-md bg-zinc-900 border-zinc-800 text-white">
              <SelectValue placeholder="Select an event" />
            </SelectTrigger>
            <SelectContent className="bg-zinc-900 border-zinc-800">
              {events.map(event => (
                <SelectItem key={event.id} value={event.id} className="text-white">{event.name}</SelectItem>
              ))}
            </SelectContent>
          </Select>

          {selectedEvent && matches.length > 0 && (
            <Button 
              onClick={handleGenerateRankings}
              disabled={generateRankingsMutation.isPending}
              className="bg-purple-500 hover:bg-purple-400 text-white"
            >
              {generateRankingsMutation.isPending ? (
                <><Loader2 className="h-4 w-4 mr-2 animate-spin" />Analyzing...</>
              ) : (
                <><Brain className="h-4 w-4 mr-2" />Generate AI Rankings</>
              )}
            </Button>
          )}
        </div>

        {!selectedEvent ? (
          <Card className="bg-zinc-900/50 border-zinc-800">
            <CardContent className="py-12 text-center">
              <Brain className="h-12 w-12 text-zinc-600 mx-auto mb-4" />
              <p className="text-zinc-400">Select an event to generate AI rankings</p>
            </CardContent>
          </Card>
        ) : matches.length === 0 ? (
          <Card className="bg-zinc-900/50 border-zinc-800">
            <CardContent className="py-12 text-center">
              <p className="text-zinc-400">No match data for this event yet</p>
            </CardContent>
          </Card>
        ) : !aiRankings ? (
          <Card className="bg-zinc-900/50 border-zinc-800">
            <CardContent className="py-12 text-center">
              <Brain className="h-12 w-12 text-purple-400 mx-auto mb-4" />
              <p className="text-zinc-400 mb-4">{[...new Set(matches.map(m => m.team_number))].length} teams scouted</p>
              <Button onClick={handleGenerateRankings} disabled={generateRankingsMutation.isPending} className="bg-purple-500 hover:bg-purple-400">
                {generateRankingsMutation.isPending ? 'Analyzing...' : 'Generate AI Rankings'}
              </Button>
            </CardContent>
          </Card>
        ) : (
          <div className="space-y-4">
            <div className="relative max-w-md">
              <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-zinc-500" />
              <Input
                placeholder="Search team number..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                className="bg-zinc-900/50 border-zinc-800 text-white pl-10 h-12 rounded-xl"
              />
            </div>
            {filteredRankings.length === 0 ? (
              <Card className="bg-zinc-900/50 border-zinc-800">
                <CardContent className="py-8 text-center">
                  <p className="text-zinc-400">No teams found matching "{searchQuery}"</p>
                </CardContent>
              </Card>
            ) : filteredRankings.map((team, index) => (
              <motion.div key={team.team_number} initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: index * 0.05 }}>
                <Card className="bg-zinc-900/50 border-zinc-800 overflow-hidden">
                  <CardContent className="p-0">
                    <div className="flex items-stretch">
                      <div className={`w-16 flex items-center justify-center ${
                        index === 0 ? 'bg-amber-500/20' : index === 1 ? 'bg-zinc-400/20' : index === 2 ? 'bg-orange-600/20' : 'bg-zinc-800/50'
                      }`}>
                        <span className={`text-2xl font-bold ${
                          index === 0 ? 'text-amber-400' : index === 1 ? 'text-zinc-300' : index === 2 ? 'text-orange-400' : 'text-zinc-500'
                        }`}>#{index + 1}</span>
                      </div>
                      <div className="flex-1 p-4">
                        <div className="flex items-center justify-between mb-3">
                          <div className="flex items-center gap-3">
                            <span className="text-xl font-bold text-white">Team {team.team_number}</span>
                            <StarRating rating={team.star_rating} />
                          </div>
                          <div className="text-right">
                            <p className="text-2xl font-bold text-cyan-400">{team.avg_score}</p>
                            <p className="text-zinc-500 text-xs">Avg Score</p>
                          </div>
                        </div>
                        <div className="grid grid-cols-5 gap-3 mb-3">
                          <div className="bg-zinc-800/50 rounded-lg p-2">
                            <div className="flex items-center gap-1.5 text-zinc-400 text-xs mb-1"><Trophy className="h-3 w-3" />Auto</div>
                            <p className="text-white font-semibold">{team.avg_auto}</p>
                          </div>
                          <div className="bg-zinc-800/50 rounded-lg p-2">
                            <div className="flex items-center gap-1.5 text-zinc-400 text-xs mb-1"><Gamepad2 className="h-3 w-3" />Teleop</div>
                            <p className="text-white font-semibold">{team.avg_teleop}</p>
                          </div>
                          <div className="bg-zinc-800/50 rounded-lg p-2">
                            <div className="flex items-center gap-1.5 text-zinc-400 text-xs mb-1"><Flag className="h-3 w-3" />End</div>
                            <p className="text-white font-semibold">{team.avg_endgame}</p>
                          </div>
                          <div className="bg-zinc-800/50 rounded-lg p-2">
                            <div className="flex items-center gap-1.5 text-zinc-400 text-xs mb-1"><TrendingUp className="h-3 w-3" />Max</div>
                            <p className="text-white font-semibold">{team.max_score}</p>
                          </div>
                          <div className="bg-zinc-800/50 rounded-lg p-2">
                            <div className="flex items-center gap-1.5 text-zinc-400 text-xs mb-1"><TrendingUp className="h-3 w-3 rotate-180" />Min</div>
                            <p className="text-white font-semibold">{team.min_score}</p>
                          </div>
                        </div>
                        {team.strengths && <p className="text-green-400 text-sm mb-1"><strong>Strengths:</strong> {team.strengths}</p>}
                        {team.analysis && <p className="text-zinc-400 text-sm">{team.analysis}</p>}
                      </div>
                    </div>
                  </CardContent>
                </Card>
              </motion.div>
            ))}
          </div>
        )}
      </div>
    </BackgroundWrapper>
  );
}

// Update star display to handle decimals
function StarRating({ rating }) {
  const fullStars = Math.floor(rating);
  const decimal = rating - fullStars;
  
  return (
    <div className="flex items-center gap-1">
      {[...Array(10)].map((_, i) => {
        if (i < fullStars) {
          return <Star key={i} className="h-4 w-4 text-amber-400 fill-amber-400" />;
        } else if (i === fullStars && decimal > 0) {
          return (
            <div key={i} className="relative">
              <Star className="h-4 w-4 text-zinc-700" />
              <div className="absolute inset-0 overflow-hidden" style={{ width: `${decimal * 100}%` }}>
                <Star className="h-4 w-4 text-amber-400 fill-amber-400" />
              </div>
            </div>
          );
        }
        return <Star key={i} className="h-4 w-4 text-zinc-700" />;
      })}
      <span className="text-amber-400 ml-2 font-bold">{rating}/10</span>
    </div>
  );
}
