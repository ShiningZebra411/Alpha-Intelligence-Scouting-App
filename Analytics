import React, { useState, useMemo } from 'react';
import { Link } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { base44 } from '@/api/base44Client';
import { useQuery } from '@tanstack/react-query';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { motion } from 'framer-motion';
import { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, LineChart, Line, RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, Radar } from 'recharts';
import BackgroundWrapper from '@/components/BackgroundWrapper';
import { ArrowLeft, BarChart3, TrendingUp } from 'lucide-react';

export default function Analytics() {
  const urlParams = new URLSearchParams(window.location.search);
  const eventId = urlParams.get('eventId');
  const [selectedTeam, setSelectedTeam] = useState('all');

  const { data: matches = [], isLoading } = useQuery({
    queryKey: ['matches', eventId],
    queryFn: () => base44.entities.MatchScout.filter({ event_id: eventId }, '-match_number'),
    enabled: !!eventId,
  });

  const teams = useMemo(() => {
    const uniqueTeams = [...new Set(matches.map(m => m.team_number))];
    return uniqueTeams.sort((a, b) => a - b);
  }, [matches]);

  const chartData = useMemo(() => {
    const filteredMatches = selectedTeam === 'all' 
      ? matches 
      : matches.filter(m => m.team_number === parseInt(selectedTeam));

    const teamStats = {};
    filteredMatches.forEach(match => {
      const team = match.team_number;
      if (!teamStats[team]) {
        teamStats[team] = { team, auto: 0, teleop: 0, endgame: 0, count: 0 };
      }
      teamStats[team].auto += match.auto_score || 0;
      teamStats[team].teleop += match.teleop_score || 0;
      teamStats[team].endgame += match.endgame_score || 0;
      teamStats[team].count += 1;
    });

    return Object.values(teamStats).map(t => ({
      name: `Team ${t.team}`,
      team: t.team,
      'Avg Auto': Math.round(t.auto / t.count),
      'Avg Teleop': Math.round(t.teleop / t.count),
      'Avg Endgame': Math.round(t.endgame / t.count),
      'Total Avg': Math.round((t.auto + t.teleop + t.endgame) / t.count)
    })).sort((a, b) => b['Total Avg'] - a['Total Avg']);
  }, [matches, selectedTeam]);

  const matchTrendData = useMemo(() => {
    if (selectedTeam === 'all') return [];
    
    return matches
      .filter(m => m.team_number === parseInt(selectedTeam))
      .sort((a, b) => a.match_number - b.match_number)
      .map(m => ({
        match: `M${m.match_number}`,
        Auto: m.auto_score || 0,
        Teleop: m.teleop_score || 0,
        Endgame: m.endgame_score || 0,
        Total: m.total_score || 0
      }));
  }, [matches, selectedTeam]);

  const radarData = useMemo(() => {
    if (selectedTeam === 'all' || chartData.length === 0) return [];
    
    const teamData = chartData.find(t => t.team === parseInt(selectedTeam));
    if (!teamData) return [];

    const maxAuto = Math.max(...chartData.map(t => t['Avg Auto'])) || 1;
    const maxTeleop = Math.max(...chartData.map(t => t['Avg Teleop'])) || 1;
    const maxEndgame = Math.max(...chartData.map(t => t['Avg Endgame'])) || 1;

    return [
      { subject: 'Auto', A: (teamData['Avg Auto'] / maxAuto) * 100, fullMark: 100 },
      { subject: 'Teleop', A: (teamData['Avg Teleop'] / maxTeleop) * 100, fullMark: 100 },
      { subject: 'Endgame', A: (teamData['Avg Endgame'] / maxEndgame) * 100, fullMark: 100 },
    ];
  }, [chartData, selectedTeam]);

return (
    <BackgroundWrapper>
      {/* Header */}
      <div className="bg-zinc-950/80 backdrop-blur-xl border-b border-zinc-900 sticky top-0 z-50">
        <div className="max-w-6xl mx-auto px-4 py-4">
          <div className="flex items-center justify-between">
            <Link 
              to={createPageUrl('EventDashboard') + `?eventId=${eventId}`} 
              className="flex items-center gap-2 text-zinc-400 hover:text-white transition-colors"
            >
              <ArrowLeft className="h-4 w-4" />
              <span className="text-sm">Dashboard</span>
            </Link>
          </div>
        </div>
      </div>

      <div className="max-w-6xl mx-auto px-4 py-8">
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          className="mb-8"
        >
          <h1 className="text-3xl font-bold text-white mb-2">Analytics</h1>
          <p className="text-zinc-500">Deep dive into team performance</p>
        </motion.div>

        {/* Team Filter */}
        <div className="mb-8">
          <Select value={selectedTeam} onValueChange={setSelectedTeam}>
            <SelectTrigger className="w-48 bg-zinc-900/80 border-zinc-800 text-white backdrop-blur-sm">
              <SelectValue placeholder="Select team" />
            </SelectTrigger>
            <SelectContent className="bg-zinc-900 border-zinc-800">
              <SelectItem value="all" className="text-white">All Teams</SelectItem>
              {teams.map(team => (
                <SelectItem key={team} value={String(team)} className="text-white">
                  Team {team}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
        </div>

        <div className="grid lg:grid-cols-2 gap-6">
          {/* Team Comparison Chart */}
          <Card className="bg-zinc-900/50 border-zinc-800 lg:col-span-2 backdrop-blur-sm">
            <CardHeader>
              <CardTitle className="text-white flex items-center gap-2">
                <BarChart3 className="h-5 w-5 text-cyan-400" />
                Team Score Comparison
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="h-80">
                <ResponsiveContainer width="100%" height="100%">
                  <BarChart data={chartData.slice(0, 10)} layout="vertical">
                    <XAxis type="number" stroke="#52525b" />
                    <YAxis dataKey="name" type="category" stroke="#52525b" width={80} tick={{ fill: '#a1a1aa', fontSize: 12 }} />
                    <Tooltip 
                      contentStyle={{ backgroundColor: '#18181b', border: '1px solid #27272a', borderRadius: '8px' }}
                      labelStyle={{ color: '#fff' }}
                    />
                    <Bar dataKey="Avg Auto" fill="#22d3ee" stackId="a" radius={[0, 0, 0, 0]} />
                    <Bar dataKey="Avg Teleop" fill="#3b82f6" stackId="a" radius={[0, 0, 0, 0]} />
                    <Bar dataKey="Avg Endgame" fill="#8b5cf6" stackId="a" radius={[0, 4, 4, 0]} />
                  </BarChart>
                </ResponsiveContainer>
              </div>
            </CardContent>
          </Card>

          {/* Match Trend Chart */}
          {selectedTeam !== 'all' && matchTrendData.length > 0 && (
            <Card className="bg-zinc-900/50 border-zinc-800 backdrop-blur-sm">
              <CardHeader>
                <CardTitle className="text-white flex items-center gap-2">
                  <TrendingUp className="h-5 w-5 text-cyan-400" />
                  Score Trend - Team {selectedTeam}
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="h-64">
                  <ResponsiveContainer width="100%" height="100%">
                    <LineChart data={matchTrendData}>
                      <XAxis dataKey="match" stroke="#52525b" tick={{ fill: '#a1a1aa', fontSize: 12 }} />
                      <YAxis stroke="#52525b" tick={{ fill: '#a1a1aa', fontSize: 12 }} />
                      <Tooltip 
                        contentStyle={{ backgroundColor: '#18181b', border: '1px solid #27272a', borderRadius: '8px' }}
                        labelStyle={{ color: '#fff' }}
                      />
                      <Line type="monotone" dataKey="Total" stroke="#22d3ee" strokeWidth={2} dot={{ fill: '#22d3ee' }} />
                      <Line type="monotone" dataKey="Auto" stroke="#22c55e" strokeWidth={1} dot={false} />
                      <Line type="monotone" dataKey="Teleop" stroke="#3b82f6" strokeWidth={1} dot={false} />
                    </LineChart>
                  </ResponsiveContainer>
                </div>
              </CardContent>
            </Card>
          )}

          {/* Radar Chart */}
          {selectedTeam !== 'all' && radarData.length > 0 && (
            <Card className="bg-zinc-900/50 border-zinc-800 backdrop-blur-sm">
              <CardHeader>
                <CardTitle className="text-white">Performance Profile</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="h-64">
                  <ResponsiveContainer width="100%" height="100%">
                    <RadarChart data={radarData}>
                      <PolarGrid stroke="#27272a" />
                      <PolarAngleAxis dataKey="subject" stroke="#a1a1aa" />
                      <PolarRadiusAxis stroke="#52525b" />
                      <Radar name="Team" dataKey="A" stroke="#22d3ee" fill="#22d3ee" fillOpacity={0.3} />
                    </RadarChart>
                  </ResponsiveContainer>
                </div>
              </CardContent>
            </Card>
          )}
        </div>
      </div>
    </BackgroundWrapper>
  );
}
