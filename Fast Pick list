import React, { useState, useMemo } from 'react';
import { Link } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { base44 } from '@/api/base44Client';
import { useQuery, useMutation } from '@tanstack/react-query';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { motion } from 'framer-motion';
import BackgroundWrapper from '@/components/BackgroundWrapper';
import { ArrowLeft, Brain, Loader2, Users, Trophy, Star } from 'lucide-react';

export default function FastPickList() {
  const [selectedEvent, setSelectedEvent] = useState(null);
  const [targetTeam, setTargetTeam] = useState('');
  const [recommendations, setRecommendations] = useState(null);

  const { data: events = [] } = useQuery({
    queryKey: ['events'],
    queryFn: () => base44.entities.Event.list('-created_date'),
  });

  const { data: matches = [] } = useQuery({
    queryKey: ['matches', selectedEvent],
    queryFn: () => base44.entities.MatchScout.filter({ event_id: selectedEvent }),
    enabled: !!selectedEvent,
  });

  const teamStats = useMemo(() => {
    const stats = {};
    matches.forEach(m => {
      if (!stats[m.team_number]) {
        stats[m.team_number] = { scores: [], auto: [], teleop: [], endgame: [], notes: [], overall: [], reliability: [] };
      }
      stats[m.team_number].scores.push(m.total_score || 0);
      stats[m.team_number].auto.push(m.auto_score || 0);
      stats[m.team_number].teleop.push(m.teleop_score || 0);
      stats[m.team_number].endgame.push(m.endgame_score || 0);
      stats[m.team_number].overall.push(m.overall_rating || 5);
      stats[m.team_number].reliability.push(m.reliability_rating || 5);
      if (m.notes) stats[m.team_number].notes.push(m.notes);
    });

    return Object.entries(stats).map(([team, data]) => ({
      team_number: parseInt(team),
      avg_score: Math.round(data.scores.reduce((a,b) => a+b, 0) / data.scores.length),
      avg_auto: Math.round(data.auto.reduce((a,b) => a+b, 0) / data.auto.length),
      avg_teleop: Math.round(data.teleop.reduce((a,b) => a+b, 0) / data.teleop.length),
      avg_endgame: Math.round(data.endgame.reduce((a,b) => a+b, 0) / data.endgame.length),
      avg_overall: (data.overall.reduce((a,b) => a+b, 0) / data.overall.length).toFixed(1),
      avg_reliability: (data.reliability.reduce((a,b) => a+b, 0) / data.reliability.length).toFixed(1),
      consistency: Math.max(...data.scores) - Math.min(...data.scores),
      notes: data.notes.join(' | ')
    }));
  }, [matches]);

  const generateRecommendationsMutation = useMutation({
    mutationFn: async () => {
      const targetStats = teamStats.find(t => t.team_number === parseInt(targetTeam));
      const otherTeams = teamStats.filter(t => t.team_number !== parseInt(targetTeam));

      const prompt = `You are an expert FTC DECODE 2025-2026 alliance selection advisor.

IMPORTANT: Use ALL available data:
1. Our scouted data below
2. FTC Scout (ftcscout.org)
3. FTC Stats (ftcstats.org/2026)
4. FIRST Events (ftc-events.firstinspires.org)

TARGET TEAM (looking for partners):
Team ${targetTeam}: ${targetStats ? JSON.stringify(targetStats) : 'No local data - search external sources'}

AVAILABLE TEAMS AT EVENT:
${JSON.stringify(otherTeams, null, 2)}

Find the TOP 10 teams that would be BEST PARTNERS for Team ${targetTeam}. Consider:
- Complementary strengths (if target is strong auto, find strong teleop partners)
- Combined scoring potential
- Reliability and consistency
- Synergy based on play styles
- Endgame coordination

Return:
{
  "target_team_summary": "brief summary of target team strengths/needs",
  "recommendations": [
    {
      "rank": 1,
      "team_number": number,
      "compatibility_score": number (1-100),
      "combined_predicted_score": number,
      "why_good_partner": "specific reasons",
      "strengths_they_add": "what they bring to the alliance"
    }
  ]
}

Sort by compatibility_score descending. Return exactly 10 teams (or all available if less than 10).`;

      const result = await base44.integrations.Core.InvokeLLM({
        prompt,
        add_context_from_internet: true,
        response_json_schema: {
          type: "object",
          properties: {
            target_team_summary: { type: "string" },
            recommendations: {
              type: "array",
              items: {
                type: "object",
                properties: {
                  rank: { type: "number" },
                  team_number: { type: "number" },
                  compatibility_score: { type: "number" },
                  combined_predicted_score: { type: "number" },
                  why_good_partner: { type: "string" },
                  strengths_they_add: { type: "string" }
                }
              }
            }
          }
        }
      });

      return result;
    },
    onSuccess: (data) => {
      setRecommendations(data);
    }
  });

  return (
    <BackgroundWrapper>
      <div className="bg-zinc-950/80 backdrop-blur-xl border-b border-zinc-900 sticky top-0 z-50">
        <div className="max-w-6xl mx-auto px-4 py-4">
          <Link to={createPageUrl('AIHub')} className="flex items-center gap-2 text-zinc-400 hover:text-white transition-colors">
            <ArrowLeft className="h-4 w-4" />
            <span className="text-sm">AI Tools</span>
          </Link>
        </div>
      </div>

      <div className="max-w-4xl mx-auto px-4 py-8">
        <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="mb-8 text-center">
          <div className="inline-flex items-center justify-center h-16 w-16 rounded-xl bg-cyan-500/20 mb-4">
            <Users className="h-8 w-8 text-cyan-400" />
          </div>
          <h1 className="text-3xl font-bold text-white mb-2">Fast Pick-List Decisions</h1>
          <p className="text-zinc-500">Find the best alliance partners for any team</p>
        </motion.div>

        <Card className="bg-zinc-900/50 border-zinc-800 mb-8">
          <CardContent className="py-6">
            <div className="grid md:grid-cols-3 gap-4 items-end">
              <div>
                <Label className="text-zinc-400 text-sm">Select Event</Label>
                <Select value={selectedEvent || ''} onValueChange={(v) => { setSelectedEvent(v); setRecommendations(null); }}>
                  <SelectTrigger className="bg-zinc-800 border-zinc-700 text-white mt-1">
                    <SelectValue placeholder="Choose event" />
                  </SelectTrigger>
                  <SelectContent className="bg-zinc-900 border-zinc-800">
                    {events.map(event => (
                      <SelectItem key={event.id} value={event.id} className="text-white">{event.name}</SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <div>
                <Label className="text-zinc-400 text-sm">Target Team Number</Label>
                <Input
                  placeholder="e.g., 15337"
                  value={targetTeam}
                  onChange={(e) => setTargetTeam(e.target.value.replace(/\D/g, ''))}
                  className="bg-zinc-800 border-zinc-700 text-white mt-1"
                />
              </div>
              <Button
                onClick={() => generateRecommendationsMutation.mutate()}
                disabled={!selectedEvent || !targetTeam || generateRecommendationsMutation.isPending}
                className="bg-cyan-500 hover:bg-cyan-400 text-black h-10"
              >
                {generateRecommendationsMutation.isPending ? (
                  <><Loader2 className="h-4 w-4 mr-2 animate-spin" />Finding...</>
                ) : (
                  <><Brain className="h-4 w-4 mr-2" />Find Partners</>
                )}
              </Button>
            </div>
          </CardContent>
        </Card>

        {recommendations && (
          <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }}>
            <Card className="bg-cyan-950/30 border-cyan-800/50 mb-6">
              <CardContent className="py-4">
                <h3 className="text-cyan-400 font-semibold mb-2">Team {targetTeam} Analysis</h3>
                <p className="text-zinc-300 text-sm">{recommendations.target_team_summary}</p>
              </CardContent>
            </Card>

            <h3 className="text-white font-semibold mb-4">Top 10 Recommended Partners</h3>
            <div className="space-y-3">
              {recommendations.recommendations?.map((rec, index) => (
                <motion.div
                  key={rec.team_number}
                  initial={{ opacity: 0, x: -20 }}
                  animate={{ opacity: 1, x: 0 }}
                  transition={{ delay: index * 0.05 }}
                >
                  <Card className="bg-zinc-900/50 border-zinc-800 overflow-hidden">
                    <CardContent className="p-0">
                      <div className="flex items-stretch">
                        <div className={`w-16 flex items-center justify-center ${
                          index === 0 ? 'bg-amber-500/20' : index === 1 ? 'bg-zinc-400/20' : index === 2 ? 'bg-orange-600/20' : 'bg-zinc-800/50'
                        }`}>
                          <span className={`text-xl font-bold ${
                            index === 0 ? 'text-amber-400' : index === 1 ? 'text-zinc-300' : index === 2 ? 'text-orange-400' : 'text-zinc-500'
                          }`}>#{rec.rank}</span>
                        </div>
                        <div className="flex-1 p-4">
                          <div className="flex items-center justify-between mb-2">
                            <span className="text-xl font-bold text-white">Team {rec.team_number}</span>
                            <div className="flex items-center gap-2">
                              <div className="bg-cyan-500/20 px-3 py-1 rounded-full">
                                <span className="text-cyan-400 font-semibold">{rec.compatibility_score}%</span>
                                <span className="text-cyan-400/70 text-sm ml-1">compatible</span>
                              </div>
                              <div className="bg-purple-500/20 px-3 py-1 rounded-full">
                                <span className="text-purple-400 font-semibold">{rec.combined_predicted_score}</span>
                                <span className="text-purple-400/70 text-sm ml-1">pts</span>
                              </div>
                            </div>
                          </div>
                          <p className="text-green-400 text-sm mb-1"><strong>Why:</strong> {rec.why_good_partner}</p>
                          <p className="text-zinc-400 text-sm"><strong>Adds:</strong> {rec.strengths_they_add}</p>
                        </div>
                      </div>
                    </CardContent>
                  </Card>
                </motion.div>
              ))}
            </div>
          </motion.div>
        )}
      </div>
    </BackgroundWrapper>
  );
}
