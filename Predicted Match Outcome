import React, { useState, useMemo } from 'react';
import { Link } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { base44 } from '@/api/base44Client';
import { useQuery, useMutation } from '@tanstack/react-query';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Input } from '@/components/ui/input';
import { motion } from 'framer-motion';
import BackgroundWrapper from '@/components/BackgroundWrapper';
import { ArrowLeft, Brain, Loader2, Trophy, RefreshCw, Zap } from 'lucide-react';

export default function PredictedMatchOutcome() {
  const [selectedEvent, setSelectedEvent] = useState(null);
  const [predictions, setPredictions] = useState(null);
  const [schedule, setSchedule] = useState([]);

  const { data: events = [] } = useQuery({
    queryKey: ['events'],
    queryFn: () => base44.entities.Event.list('-created_date'),
  });

  const { data: matches = [] } = useQuery({
    queryKey: ['matches', selectedEvent],
    queryFn: () => base44.entities.MatchScout.filter({ event_id: selectedEvent }),
    enabled: !!selectedEvent,
  });

  const teamStats = useMemo(() => {
    const stats = {};
    matches.forEach(m => {
      if (!stats[m.team_number]) {
        stats[m.team_number] = { scores: [], notes: [], auto: [], teleop: [], endgame: [], overall: [], reliability: [] };
      }
      stats[m.team_number].scores.push(m.total_score || 0);
      stats[m.team_number].auto.push(m.auto_score || 0);
      stats[m.team_number].teleop.push(m.teleop_score || 0);
      stats[m.team_number].endgame.push(m.endgame_score || 0);
      stats[m.team_number].overall.push(m.overall_rating || 5);
      stats[m.team_number].reliability.push(m.reliability_rating || 5);
      if (m.notes) stats[m.team_number].notes.push(m.notes);
    });
    
    return Object.entries(stats).map(([team, data]) => ({
      team_number: parseInt(team),
      avg_score: Math.round(data.scores.reduce((a,b) => a+b, 0) / data.scores.length),
      avg_auto: Math.round(data.auto.reduce((a,b) => a+b, 0) / data.auto.length),
      avg_teleop: Math.round(data.teleop.reduce((a,b) => a+b, 0) / data.teleop.length),
      avg_endgame: Math.round(data.endgame.reduce((a,b) => a+b, 0) / data.endgame.length),
      avg_overall: (data.overall.reduce((a,b) => a+b, 0) / data.overall.length).toFixed(1),
      avg_reliability: (data.reliability.reduce((a,b) => a+b, 0) / data.reliability.length).toFixed(1),
      max_score: Math.max(...data.scores),
      min_score: Math.min(...data.scores),
      notes: data.notes.join(' | ')
    }));
  }, [matches]);

  const addMatchMutation = useMutation({
    mutationFn: async (matchData) => {
      setSchedule(prev => [...prev, matchData]);
    }
  });

  const generatePredictionsMutation = useMutation({
    mutationFn: async () => {
      if (schedule.length === 0) return { predictions: [] };

      const prompt = `You are an expert FTC DECODE 2025-2026 match analyst.

IMPORTANT: Use ALL available data sources:
1. Our scouted data with notes
2. FTC Scout (ftcscout.org)
3. FTC Stats (ftcstats.org/2026)
4. FIRST Events (ftc-events.firstinspires.org)

Team Statistics from scouting:
${JSON.stringify(teamStats, null, 2)}

Match Schedule to predict:
${JSON.stringify(schedule, null, 2)}

For each match, analyze:
- Team averages and consistency (high vs low scores)
- Scouter notes about teams
- OPR/CCWM from external sources
- Historical performance

Return predictions:
{
  "predictions": [
    {
      "match_number": number,
      "red_alliance": [team1, team2],
      "blue_alliance": [team1, team2],
      "predicted_winner": "red" or "blue",
      "confidence": number (1-100),
      "red_predicted_score": number,
      "blue_predicted_score": number,
      "analysis": "brief reasoning"
    }
  ]
}`;

      const result = await base44.integrations.Core.InvokeLLM({
        prompt,
        add_context_from_internet: true,
        response_json_schema: {
          type: "object",
          properties: {
            predictions: {
              type: "array",
              items: {
                type: "object",
                properties: {
                  match_number: { type: "number" },
                  red_alliance: { type: "array", items: { type: "number" } },
                  blue_alliance: { type: "array", items: { type: "number" } },
                  predicted_winner: { type: "string" },
                  confidence: { type: "number" },
                  red_predicted_score: { type: "number" },
                  blue_predicted_score: { type: "number" },
                  analysis: { type: "string" }
                }
              }
            }
          }
        }
      });

      return result;
    },
    onSuccess: (data) => {
      setPredictions(data.predictions);
    }
  });

  const [newMatch, setNewMatch] = useState({ match_number: '', red1: '', red2: '', blue1: '', blue2: '' });

  const handleAddMatch = () => {
    if (newMatch.match_number && newMatch.red1 && newMatch.red2 && newMatch.blue1 && newMatch.blue2) {
      addMatchMutation.mutate({
        match_number: parseInt(newMatch.match_number),
        red_alliance: [parseInt(newMatch.red1), parseInt(newMatch.red2)],
        blue_alliance: [parseInt(newMatch.blue1), parseInt(newMatch.blue2)]
      });
      setNewMatch({ match_number: '', red1: '', red2: '', blue1: '', blue2: '' });
    }
  };

  return (
    <BackgroundWrapper>
      <div className="bg-zinc-950/80 backdrop-blur-xl border-b border-zinc-900 sticky top-0 z-50">
        <div className="max-w-6xl mx-auto px-4 py-4">
          <Link to={createPageUrl('AIHub')} className="flex items-center gap-2 text-zinc-400 hover:text-white transition-colors">
            <ArrowLeft className="h-4 w-4" />
            <span className="text-sm">AI Tools</span>
          </Link>
        </div>
      </div>

      <div className="max-w-6xl mx-auto px-4 py-8">
        <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="mb-8">
          <div className="flex items-center gap-3 mb-2">
            <Zap className="h-8 w-8 text-amber-400" />
            <h1 className="text-3xl font-bold text-white">Predicted Match Outcome</h1>
          </div>
          <p className="text-zinc-500">AI predicts match winners based on all available data</p>
        </motion.div>

        <div className="mb-6">
          <Select value={selectedEvent || ''} onValueChange={(v) => { setSelectedEvent(v); setPredictions(null); setSchedule([]); }}>
            <SelectTrigger className="w-full max-w-md bg-zinc-900 border-zinc-800 text-white">
              <SelectValue placeholder="Select an event" />
            </SelectTrigger>
            <SelectContent className="bg-zinc-900 border-zinc-800">
              {events.map(event => (
                <SelectItem key={event.id} value={event.id} className="text-white">{event.name}</SelectItem>
              ))}
            </SelectContent>
          </Select>
        </div>

        {selectedEvent && (
          <>
            <Card className="bg-zinc-900/50 border-zinc-800 mb-6">
              <CardHeader>
                <CardTitle className="text-white">Add Match to Schedule</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-5 gap-3 mb-4">
                  <Input
                    placeholder="Match #"
                    value={newMatch.match_number}
                    onChange={(e) => setNewMatch({ ...newMatch, match_number: e.target.value.replace(/\D/g, '') })}
                    className="bg-zinc-800 border-zinc-700 text-white"
                  />
                  <Input
                    placeholder="Red 1"
                    value={newMatch.red1}
                    onChange={(e) => setNewMatch({ ...newMatch, red1: e.target.value.replace(/\D/g, '') })}
                    className="bg-zinc-800 border-zinc-700 text-white border-l-4 border-l-red-500"
                  />
                  <Input
                    placeholder="Red 2"
                    value={newMatch.red2}
                    onChange={(e) => setNewMatch({ ...newMatch, red2: e.target.value.replace(/\D/g, '') })}
                    className="bg-zinc-800 border-zinc-700 text-white border-l-4 border-l-red-500"
                  />
                  <Input
                    placeholder="Blue 1"
                    value={newMatch.blue1}
                    onChange={(e) => setNewMatch({ ...newMatch, blue1: e.target.value.replace(/\D/g, '') })}
                    className="bg-zinc-800 border-zinc-700 text-white border-l-4 border-l-blue-500"
                  />
                  <Input
                    placeholder="Blue 2"
                    value={newMatch.blue2}
                    onChange={(e) => setNewMatch({ ...newMatch, blue2: e.target.value.replace(/\D/g, '') })}
                    className="bg-zinc-800 border-zinc-700 text-white border-l-4 border-l-blue-500"
                  />
                </div>
                <Button onClick={handleAddMatch} className="bg-cyan-500 hover:bg-cyan-400 text-black">
                  Add Match
                </Button>
              </CardContent>
            </Card>

            {schedule.length > 0 && (
              <div className="mb-6">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-white font-semibold">Schedule ({schedule.length} matches)</h3>
                  <Button 
                    onClick={() => generatePredictionsMutation.mutate()}
                    disabled={generatePredictionsMutation.isPending}
                    className="bg-amber-500 hover:bg-amber-400 text-black"
                  >
                    {generatePredictionsMutation.isPending ? (
                      <><Loader2 className="h-4 w-4 mr-2 animate-spin" />Predicting...</>
                    ) : (
                      <><Brain className="h-4 w-4 mr-2" />Generate Predictions</>
                    )}
                  </Button>
                </div>

                <div className="space-y-3">
                  {schedule.map((match, i) => {
                    const prediction = predictions?.find(p => p.match_number === match.match_number);
                    return (
                      <Card key={i} className="bg-zinc-900/50 border-zinc-800">
                        <CardContent className="py-4">
                          <div className="flex items-center justify-between">
                            <span className="text-zinc-400 font-medium">Match {match.match_number}</span>
                            <div className="flex items-center gap-4">
                              <div className={`px-3 py-1 rounded-lg ${prediction?.predicted_winner === 'red' ? 'bg-red-500/30 ring-2 ring-red-500' : 'bg-red-500/20'}`}>
                                <span className="text-red-400 font-medium">{match.red_alliance.join(' & ')}</span>
                                {prediction && <span className="text-red-300 ml-2">({prediction.red_predicted_score})</span>}
                              </div>
                              <span className="text-zinc-500">vs</span>
                              <div className={`px-3 py-1 rounded-lg ${prediction?.predicted_winner === 'blue' ? 'bg-blue-500/30 ring-2 ring-blue-500' : 'bg-blue-500/20'}`}>
                                <span className="text-blue-400 font-medium">{match.blue_alliance.join(' & ')}</span>
                                {prediction && <span className="text-blue-300 ml-2">({prediction.blue_predicted_score})</span>}
                              </div>
                            </div>
                            {prediction && (
                              <div className="text-right">
                                <p className="text-xs text-zinc-500">Confidence</p>
                                <p className="text-cyan-400 font-bold">{prediction.confidence}%</p>
                              </div>
                            )}
                          </div>
                          {prediction?.analysis && (
                            <p className="text-zinc-500 text-sm mt-2">{prediction.analysis}</p>
                          )}
                        </CardContent>
                      </Card>
                    );
                  })}
                </div>
              </div>
            )}
          </>
        )}
      </div>
    </BackgroundWrapper>
  );
}
